<!DOCTYPE html>
<html>
<head>
    <title>Complete Customer Flow Test</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; max-width: 800px; margin: 0 auto; }
        .step { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #6B0E9B; }
        .success { border-left-color: #10b981; background: #d4edda; }
        .error { border-left-color: #ef4444; background: #f8d7da; }
        button { padding: 12px 24px; background: #6B0E9B; color: white; border: none; border-radius: 6px; cursor: pointer; margin: 5px; }
        button:hover { background: #5A0C82; }
        h1 { color: #6B0E9B; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üß™ Complete Customer Order Flow Test</h1>
    <p>This will test the entire customer journey from start to finish</p>
    
    <div id="steps"></div>
    
    <button onclick="startTest()">‚ñ∂Ô∏è Start Full Test</button>
    <button onclick="justPlaceOrder()">üöÄ Quick Order (API)</button>
    <button onclick="window.open('http://localhost:3001/online-pos/68f8837a541316c6ad54b79f', '_blank')">üìä Open POS Page</button>

    <script>
        const stepsDiv = document.getElementById('steps');
        
        function addStep(title, content, type = '') {
            const step = document.createElement('div');
            step.className = 'step ' + type;
            step.innerHTML = `<h3>${title}</h3>${content}`;
            stepsDiv.appendChild(step);
            window.scrollTo(0, document.body.scrollHeight);
        }

        async function startTest() {
            stepsDiv.innerHTML = '';
            
            // Step 1: Add test data to localStorage
            addStep('Step 1: Setting up cart data', '<p>Adding checkout data to localStorage...</p>');
            
            const checkoutData = {
                theaterId: "68f8837a541316c6ad54b79f",
                theaterName: "Test Theater",
                qrName: "A1",
                seat: "Seat-A1",
                cartItems: [
                    {
                        _id: "68fc97311263296dbc0ac4c9",
                        name: "Pop Corn",
                        price: 200,
                        quantity: 3
                    }
                ],
                totals: {
                    subtotal: 600,
                    tax: 30,
                    total: 630,
                    totalDiscount: 0
                }
            };
            
            localStorage.setItem('checkoutData', JSON.stringify(checkoutData));
            addStep('‚úÖ Step 1 Complete', '<pre>' + JSON.stringify(checkoutData, null, 2) + '</pre>', 'success');
            
            // Step 2: Now we can place the order
            addStep('Step 2: Placing order via API', '<p>Sending order to backend...</p>');
            
            try {
                const orderData = {
                    theaterId: checkoutData.theaterId,
                    customerName: "+919944400587",
                    customerInfo: {
                        name: "Test Customer",
                        phone: "+919944400587"
                    },
                    tableNumber: checkoutData.seat,
                    items: checkoutData.cartItems.map(item => ({
                        productId: item._id,
                        quantity: item.quantity
                    })),
                    paymentMethod: "upi"
                };

                const response = await fetch('http://localhost:5000/api/orders/theater', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();

                if (response.ok) {
                    addStep('‚úÖ Step 2 Complete - Order Created!', `
                        <p><strong>Order Number:</strong> ${result.order.orderNumber}</p>
                        <p><strong>Customer:</strong> ${result.order.customerInfo.phone}</p>
                        <p><strong>Items:</strong> ${result.order.items.map(i => `${i.name} x${i.quantity}`).join(', ')}</p>
                        <p><strong>Total:</strong> ‚Çπ${result.order.pricing.total}</p>
                        <p><strong>Status:</strong> ${result.order.status}</p>
                    `, 'success');
                    
                    // Step 3: Verify in GET endpoint
                    addStep('Step 3: Verifying order appears in POS', '<p>Fetching orders...</p>');
                    
                    const ordersResponse = await fetch(`http://localhost:5000/api/orders/theater/68f8837a541316c6ad54b79f?source=qr_code`);
                    const ordersData = await ordersResponse.json();
                    
                    if (ordersData.success && ordersData.orders.length > 0) {
                        addStep('‚úÖ Step 3 Complete - Orders Retrieved!', `
                            <p>Found ${ordersData.total} customer orders</p>
                            <p><strong>Latest Order:</strong> ${ordersData.orders[0].orderNumber}</p>
                        `, 'success');
                        
                        // Open POS page
                        addStep('üéâ TEST COMPLETE!', `
                            <p style="font-size: 18px; font-weight: bold;">All steps passed successfully!</p>
                            <p>Opening Online POS page in 2 seconds...</p>
                            <p style="background: #fff3cd; padding: 10px; border-radius: 4px;">
                                üí° Scroll down on the POS page to see "Customer Orders (QR Code)" section
                            </p>
                        `, 'success');
                        
                        setTimeout(() => {
                            window.open('http://localhost:3001/online-pos/68f8837a541316c6ad54b79f', '_blank');
                        }, 2000);
                    }
                } else {
                    throw new Error(result.error || 'Order failed');
                }
                
            } catch (error) {
                addStep('‚ùå Error', `<p>${error.message}</p><pre>${error.stack}</pre>`, 'error');
            }
        }

        async function justPlaceOrder() {
            stepsDiv.innerHTML = '';
            addStep('üöÄ Quick Order', '<p>Placing order via API...</p>');
            
            try {
                const response = await fetch('http://localhost:5000/api/orders/theater', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        theaterId: "68f8837a541316c6ad54b79f",
                        customerName: "+919944400587",
                        customerInfo: { name: "Quick Test", phone: "+919944400587" },
                        tableNumber: "Seat-A1",
                        items: [{ productId: "68fc97311263296dbc0ac4c9", quantity: 2 }],
                        paymentMethod: "card"
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    addStep('‚úÖ Order Created!', `
                        <p><strong>${result.order.orderNumber}</strong></p>
                        <p>${result.order.items[0].name} x ${result.order.items[0].quantity}</p>
                        <p><strong>Total:</strong> ‚Çπ${result.order.pricing.total}</p>
                    `, 'success');
                    
                    setTimeout(() => {
                        window.open('http://localhost:3001/online-pos/68f8837a541316c6ad54b79f', '_blank');
                    }, 1500);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                addStep('‚ùå Error', `<p>${error.message}</p>`, 'error');
            }
        }
    </script>
</body>
</html>
